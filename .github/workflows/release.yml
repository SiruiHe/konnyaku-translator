name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            bundles: dmg,app
          - os: windows-latest
            bundles: nsis
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Extract changelog
        id: changelog
        env:
          RELEASE_TAG: ${{ inputs.tag || github.ref_name }}
        run: |
          python - <<'PY'
          import os
          import re

          tag = os.environ.get("RELEASE_TAG", "").strip()
          version = tag.lstrip("v")
          with open("CHANGELOG.md", "r", encoding="utf-8") as f:
            text = f.read()

          pattern = re.compile(rf"^##\\s+v?{re.escape(version)}\\s*$", re.M)
          match = pattern.search(text)
          body = "See CHANGELOG.md for details."
          if match:
            start = match.end()
            next_match = re.search(r"^##\\s+", text[start:], re.M)
            section = text[start:start + (next_match.start() if next_match else len(text) - start)].strip()
            if section:
              heading = tag if tag else f"v{version}"
              body = f"## {heading}\\n\\n{section}"

          delimiter = "CHANGELOG_END"
          if delimiter in body:
            delimiter = "CHANGELOG_END_1"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
            fh.write(f"body<<{delimiter}\\n{body}\\n{delimiter}\\n")
          PY

      - name: Build and release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ inputs.tag || github.ref_name }}
          releaseName: "Konnyaku Translator ${{ inputs.tag || github.ref_name }}"
          releaseBody: ${{ steps.changelog.outputs.body }}
          releaseDraft: false
          prerelease: false
          updaterJsonPreferNsis: true
          args: "--bundles ${{ matrix.bundles }}"
